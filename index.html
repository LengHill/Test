<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мій Фінансовий Трекер PWA</title>
    
    <!-- PWA та Маніфест -->
    <link rel="manifest" href="./finance_manifest.json">
    <meta name="theme-color" content="#4F46E5">

    <!-- CDN для React, Babel та Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CDN для Firebase SDKs (v9.x MODULAR - працюють з глобальним об'єктом) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

    <style>
        /* Стилі для основного шрифту */
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        /**
         * Головна функція, яка запускає React-додаток.
         * Вона викликається лише після повного завантаження сторінки (window.onload),
         * що гарантує доступність глобального об'єкта `firebase`.
         */
        const renderApp = () => {
            if (typeof firebase === 'undefined' || typeof firebase.app === 'undefined') {
                console.error("Firebase is not loaded correctly. Cannot proceed.");
                // Fallback rendering a message if firebase fails to load
                const RootApp = () => (
                    <div className="flex items-center justify-center min-h-screen bg-gray-50 p-4">
                        <div className="text-center">
                            <h1 className="text-3xl font-bold text-red-600 mb-4">Помилка Завантаження</h1>
                            <p className="text-gray-700">Не вдалося завантажити необхідні бібліотеки Firebase. Будь ласка, перевірте ваше підключення до мережі та спробуйте оновити сторінку.</p>
                        </div>
                    </div>
                );
                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(<RootApp />);
                return;
            }
            
            // Отримання глобальних змінних середовища
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // Деструктуризація для зручності
            const { useState, useEffect, useMemo, useCallback } = React;
            
            // --- ПРАВИЛЬНИЙ ДОСТУП ДО МОДУЛЬНИХ ФУНКЦІЙ через об'єкти служб ---
            // Об'єкти служб (доступні на глобальному рівні після завантаження CDN)
            // Доступ до firebase гарантований завдяки window.onload
            const appModule = firebase.app;
            const authModule = firebase.auth;
            const firestoreModule = firebase.firestore;
            
            // Деструктуризація функцій з відповідних модулів
            const { initializeApp } = appModule;
            const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = authModule;
            const { 
                getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, setLogLevel, serverTimestamp 
            } = firestoreModule;
            // -------------------------------------------------------------------------------
            
            // --- ДОПОМІЖНІ ФУНКЦІЇ ТА КОНСТАНТИ ---
            
            const MONTH_NAMES = [
              'Січень', 'Лютий', 'Березень', 'Квітень', 'Травень', 'Червень',
              'Липень', 'Серпень', 'Вересень', 'Жовтень', 'Листопад', 'Грудень'
            ];

            const getTodayDate = () => {
              const today = new Date();
              const year = today.getFullYear();
              const month = String(today.getMonth() + 1).padStart(2, '0');
              const day = String(today.getDate()).padStart(2, '0');
              return `${year}-${month}-${day}`;
            };

            // Компонент для відображення місячного графіка
            const MonthlyChart = ({ summary, formatCurrency }) => {
              if (summary.length === 0) return null;

              const maxAbsValue = Math.max(...summary.map(m => Math.max(m.income, m.expense)));

              // Обмежуємо останніми 6 місяцями
              const recentSummary = summary.slice(0, 6).reverse(); 

              return (
                <div className="bg-white shadow-lg rounded-2xl p-6 mb-8">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">Графік Доходів та Витрат (Останні {recentSummary.length} міс.)</h2>
                  <div className="flex flex-col space-y-4">
                    {recentSummary.map((m) => {
                      const monthIndex = parseInt(m.monthYear.substring(5, 7)) - 1;
                      const monthName = MONTH_NAMES[monthIndex];
                      const year = m.monthYear.substring(0, 4);
                      const incomePercent = maxAbsValue > 0 ? (m.income / maxAbsValue) * 100 : 0;
                      const expensePercent = maxAbsValue > 0 ? (m.expense / maxAbsValue) * 100 : 0;
                      const monthBalance = m.income - m.expense;
                      
                      return (
                        <div key={m.monthYear} className="flex flex-col">
                          <div className="flex justify-between items-center text-sm font-medium mb-1">
                            <span className="text-gray-600">{monthName} {year}</span>
                            <span className={`font-semibold ${monthBalance >= 0 ? 'text-indigo-600' : 'text-red-600'}`}>
                                Баланс: {formatCurrency(monthBalance)}
                            </span>
                          </div>

                          {/* Смуги графіка */}
                          <div className="flex h-4 rounded-lg overflow-hidden bg-gray-200">
                            <div 
                              style={{ width: `${incomePercent}%` }} 
                              className="bg-green-500 transition-all duration-500 ease-out" 
                              title={`Дохід: ${formatCurrency(m.income)}`}
                            />
                            <div 
                              style={{ width: `${expensePercent}%` }}
                              className="bg-red-500 transition-all duration-500 ease-out" 
                              title={`Витрати: ${formatCurrency(m.expense)}`}
                            />
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            };

            const App = () => {
              const [db, setDb] = useState(null);
              const [userId, setUserId] = useState(null);
              const [transactions, setTransactions] = useState([]);
              const [isLoading, setIsLoading] = useState(true);
              const [error, setError] = useState(null);
              const [newTransaction, setNewTransaction] = useState({
                description: '',
                amount: '',
                type: 'expense', 
                date: getTodayDate()
              });

              // Функція для примусового оновлення сторінки
              const handleRefresh = () => {
                  window.location.reload();
              };

              // 1. Ініціалізація Firebase та Аутентифікація
              useEffect(() => {
                if (typeof firebase === 'undefined') {
                    setError("Firebase SDK не завантажено. Перевірте підключення до мережі.");
                    setIsLoading(false);
                    return;
                }
                
                setLogLevel('error');

                try {
                  if (!firebaseConfig.apiKey) {
                    console.warn("Firebase config is missing, app will not save data.");
                  }

                  const app = initializeApp(firebaseConfig);
                  const firestore = getFirestore(app);
                  const userAuth = getAuth(app);

                  setDb(firestore);

                  const unsubscribe = onAuthStateChanged(userAuth, (user) => {
                    if (user) {
                      setUserId(user.uid);
                    } else {
                      const signIn = async () => {
                        try {
                          if (initialAuthToken) {
                            await signInWithCustomToken(userAuth, initialAuthToken);
                          } else {
                            await signInAnonymously(userAuth);
                          }
                        } catch (e) {
                          console.error("Error during Firebase sign-in:", e);
                          setError("Не вдалося увійти до Firebase.");
                        }
                      };
                      signIn();
                    }
                    setIsLoading(false);
                  });

                  return () => unsubscribe();
                } catch (e) {
                  console.error("Initialization Error (Detailed):", e);
                  setError("Помилка ініціалізації додатку. Будь ласка, перевірте КОНСОЛЬ браузера (F12) для деталей!");
                  setIsLoading(false);
                }
              }, []);

              // 2. Отримання даних з Firestore
              useEffect(() => {
                if (!db || !userId) return;

                const collectionPath = `artifacts/${appId}/users/${userId}/transactions`;
                const transactionsCollection = collection(db, collectionPath);
                const q = query(transactionsCollection);

                // onSnapshot забезпечує оновлення в реальному часі
                const unsubscribe = onSnapshot(q, (snapshot) => {
                  const fetchedTransactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                  })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                  setTransactions(fetchedTransactions);
                }, (e) => {
                  console.error("Error fetching transactions:", e);
                  setError("Помилка при отриманні транзакцій.");
                });

                return () => unsubscribe();
              }, [db, userId]);

              // Розрахунок загального балансу та місячних підсумків
              const { totalBalance, monthlySummary, totalIncome, totalExpense } = useMemo(() => {
                let balance = 0;
                let income = 0;
                let expense = 0;
                const monthlyData = {};

                transactions.forEach(t => {
                  const amount = t.amount || 0;
                  
                  if (t.type === 'income') {
                    balance += amount;
                    income += amount;
                  } else {
                    balance -= amount;
                    expense += amount;
                  }

                  let date;
                  if (t.timestamp && t.timestamp.toDate) {
                    date = t.timestamp.toDate();
                  } else if (t.timestamp instanceof Date) {
                    date = t.timestamp;
                  } else {
                    date = new Date(t.timestamp || getTodayDate()); 
                  }
                  
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, '0'); 
                  const monthYear = `${year}-${month}`;

                  if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { 
                      income: 0, 
                      expense: 0, 
                      monthYear,
                      monthName: MONTH_NAMES[date.getMonth()] 
                    };
                  }

                  if (t.type === 'income') {
                    monthlyData[monthYear].income += amount;
                  } else {
                    monthlyData[monthYear].expense += amount;
                  }
                });

                const sortedMonthlySummary = Object.values(monthlyData).sort((a, b) => {
                  return b.monthYear.localeCompare(a.monthYear);
                });

                return { 
                  totalBalance: balance, 
                  monthlySummary: sortedMonthlySummary,
                  totalIncome: income,
                  totalExpense: expense
                };
              }, [transactions]);

              // Обробники форми та видалення (не змінено)
              const handleInputChange = (e) => {
                const { name, value } = e.target;
                setNewTransaction(prev => ({ ...prev, [name]: value }));
              };

              const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                if (!db || !userId) {
                  setError("Додаток ще не ініціалізований. Зачекайте.");
                  return;
                }

                const { description, amount, type, date } = newTransaction; 

                const parsedAmount = parseFloat(amount);
                if (!description || parsedAmount <= 0 || isNaN(parsedAmount)) {
                  setError("Будь ласка, введіть коректний опис і суму.");
                  return;
                }

                const transactionDate = new Date(date);
                if (isNaN(transactionDate.getTime())) {
                  setError("Некоректний формат дати.");
                  return;
                }

                const transactionData = {
                  description,
                  amount: parsedAmount,
                  type,
                  timestamp: transactionDate, 
                  userId,
                };

                try {
                  const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                  await addDoc(collectionRef, transactionData);

                  setNewTransaction({ description: '', amount: '', type: 'expense', date: getTodayDate() }); 
                  setError(null);
                } catch (e) {
                  console.error("Error adding document: ", e);
                  setError("Помилка при збереженні транзакції.");
                }
              }, [newTransaction, db, userId]);

              const handleDelete = useCallback(async (id) => {
                if (!db || !userId) return;

                try {
                  const docPath = `artifacts/${appId}/users/${userId}/transactions/${id}`;
                  await deleteDoc(doc(db, docPath));
                  setError(null);
                } catch (e) {
                  console.error("Error deleting document: ", e);
                  setError("Помилка при видаленні транзакції.");
                }
              }, [db, userId]);

              const formatCurrency = (value) => {
                return new Intl.NumberFormat('pl-PL', {
                  style: 'currency',
                  currency: 'PLN',
                  maximumFractionDigits: 2
                }).format(value);
              };

              if (isLoading) {
                return (
                  <div className="flex items-center justify-center min-h-screen bg-gray-50">
                    <div className="text-xl font-semibold text-indigo-600">Завантаження...</div>
                  </div>
                );
              }

              return (
                <div className="min-h-screen bg-gray-100 p-4 sm:p-6 font-sans">
                  <div className="max-w-xl mx-auto">
                    <header className="text-center mb-6">
                      <h1 className="text-3xl font-bold text-gray-800 mb-1">Мій Фінансовий Трекер</h1>
                      {/* ОНОВЛЕНО: Додано кнопку для примусового оновлення сторінки */}
                      <div className="flex justify-center items-center space-x-4 mt-2">
                          <p className="text-sm text-gray-500">
                              ID користувача: <span className="font-mono text-xs p-1 bg-white rounded-md">{userId || 'Недоступно'}</span>
                          </p>
                          <button
                              onClick={handleRefresh}
                              className="flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-800 p-1 rounded-lg transition duration-150"
                              title="Примусово оновити сторінку та дані"
                          >
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m15.356 2H21v-5m-5.447 15.447L15 21" />
                              </svg>
                              Оновити
                          </button>
                      </div>
                    </header>

                    {error && (
                      <div className="p-3 mb-4 text-sm text-red-800 bg-red-100 rounded-lg" role="alert">
                        {error}
                      </div>
                    )}

                    {/* Картка загального балансу */}
                    <div className="bg-white shadow-xl rounded-2xl p-6 mb-8 border-t-4 border-indigo-500">
                      <h2 className="text-lg font-semibold text-gray-700 mb-2">Загальний Баланс за Весь Час</h2>
                      <p className={`text-4xl font-extrabold ${totalBalance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                        {formatCurrency(totalBalance)}
                      </p>
                      <div className="mt-4 flex justify-between text-sm font-medium">
                        <div className="text-green-500">
                          Загальний Дохід: {formatCurrency(totalIncome)}
                        </div>
                        <div className="text-red-500">
                          Загальні Витрати: {formatCurrency(totalExpense)}
                        </div>
                      </div>
                    </div>

                    {/* Графік по місяцях */}
                    <MonthlyChart summary={monthlySummary} formatCurrency={formatCurrency} />

                    {/* Форма додавання транзакції */}
                    <div className="bg-white shadow-lg rounded-2xl p-6 mb-8">
                      <h2 className="text-xl font-bold text-gray-800 mb-4">Додати Нову Транзакцію</h2>
                      <form onSubmit={handleSubmit} className="space-y-4">
                        {/* Вибір типу */}
                        <div className="flex space-x-4">
                          <label className={`flex-1 p-3 text-center rounded-lg cursor-pointer transition duration-200 ${newTransaction.type === 'income' ? 'bg-green-100 border-2 border-green-500 text-green-700 font-semibold' : 'bg-gray-50 border border-gray-300 text-gray-600'}`}>
                            <input type="radio" name="type" value="income" checked={newTransaction.type === 'income'} onChange={handleInputChange} className="hidden" />
                            Дохід (+)
                          </label>
                          <label className={`flex-1 p-3 text-center rounded-lg cursor-pointer transition duration-200 ${newTransaction.type === 'expense' ? 'bg-red-100 border-2 border-red-500 text-red-700 font-semibold' : 'bg-gray-50 border border-gray-300 text-gray-600'}`}>
                            <input type="radio" name="type" value="expense" checked={newTransaction.type === 'expense'} onChange={handleInputChange} className="hidden" />
                            Витрата (-)
                          </label>
                        </div>

                        {/* Опис */}
                        <div>
                          <label htmlFor="description" className="block text-sm font-medium text-gray-700 mb-1">Опис</label>
                          <input type="text" id="description" name="description" value={newTransaction.description} onChange={handleInputChange} placeholder="Оренда, зарплата, кава..." required className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" />
                        </div>
                        
                        {/* Дата Транзакції */}
                        <div>
                          <label htmlFor="date" className="block text-sm font-medium text-gray-700 mb-1">Дата Транзакції</label>
                          <input type="date" id="date" name="date" value={newTransaction.date} onChange={handleInputChange} required className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" />
                        </div>

                        {/* Сума */}
                        <div>
                          <label htmlFor="amount" className="block text-sm font-medium text-gray-700 mb-1">Сума (PLN)</label>
                          <input type="number" id="amount" name="amount" value={newTransaction.amount} onChange={handleInputChange} placeholder="1000.00" required min="0.01" step="0.01" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" />
                        </div>

                        {/* Кнопка додавання */}
                        <button type="submit" className="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 transform hover:scale-[1.01]" disabled={!db || !userId}>
                          Додати
                        </button>
                      </form>
                    </div>
                    
                    {/* Місячна розбивка (Детальна таблиця) */}
                    <div className="bg-white shadow-lg rounded-2xl p-6 mb-8">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">Детальна Місячна Розбивка</h2>
                        {monthlySummary.length === 0 ? (
                            <p className="text-gray-500 text-center py-2">Немає даних для розбивки.</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Місяць</th>
                                            <th className="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Дохід</th>
                                            <th className="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Витрати</th>
                                            <th className="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Баланс</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {monthlySummary.map(m => {
                                            const monthBalance = m.income - m.expense;
                                            return (
                                                <tr key={m.monthYear} className="hover:bg-indigo-50 transition duration-150">
                                                    <td className="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{m.monthName} {m.monthYear.substring(0, 4)}</td>
                                                    <td className="px-3 py-3 whitespace-nowrap text-sm text-green-600 text-right">{formatCurrency(m.income)}</td>
                                                    <td className="px-3 py-3 whitespace-nowrap text-sm text-red-600 text-right">{formatCurrency(m.expense)}</td>
                                                    <td className={`px-3 py-3 whitespace-nowrap text-sm font-bold text-right ${monthBalance >= 0 ? 'text-indigo-600' : 'text-red-600'}`}>
                                                        {formatCurrency(monthBalance)}
                                                    </td>
                                                </tr>
                                            )
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>

                    {/* Список транзакцій */}
                    <div className="bg-white shadow-lg rounded-2xl p-6">
                      <h2 className="text-xl font-bold text-gray-800 mb-4">Історія Транзакцій ({transactions.length})</h2>

                      {transactions.length === 0 ? (
                        <p className="text-gray-500 text-center py-4">Поки що транзакцій немає. Додайте першу!</p>
                      ) : (
                        <ul className="space-y-3">
                          {transactions.map(t => (
                            <li
                              key={t.id}
                              className={`flex justify-between items-center p-4 rounded-xl shadow-sm transition duration-150 ease-in-out border-l-4 ${
                                t.type === 'income' ? 'border-green-500 bg-green-50 hover:bg-green-100' : 'border-red-500 bg-red-50 hover:bg-red-100'
                              }`}
                            >
                              {/* Опис і дата */}
                              <div className="flex-1 min-w-0 pr-4">
                                <p className="font-semibold text-gray-800 truncate">{t.description}</p>
                                <p className="text-xs text-gray-500 mt-0.5">
                                  {t.timestamp?.toDate ? t.timestamp.toDate().toLocaleDateString('uk-UA', { year: 'numeric', month: 'long', day: 'numeric' }) : new Date(t.timestamp).toLocaleDateString('uk-UA', { year: 'numeric', month: 'long', day: 'numeric' })}
                                </p>
                              </div>

                              {/* Сума */}
                              <div className="text-right flex items-center">
                                <span className={`font-bold text-lg mr-4 ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>
                                  {t.type === 'income' ? '+' : '-'}{formatCurrency(t.amount)}
                                </span>
                                {/* Кнопка видалення */}
                                <button
                                  onClick={() => handleDelete(t.id)}
                                  className="text-gray-400 hover:text-red-600 p-1 rounded-full transition duration-150 focus:outline-none focus:ring-2 focus:ring-red-500"
                                  aria-label="Видалити транзакцію"
                                >
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                  </svg>
                                </button>
                              </div>
                            </li>
                          ))}
                        </ul>
                      )}
                    </div>
                  </div>
                </div>
              );
            };
            
            // Рендеринг React-додатку (Оновлено для React 18)
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);

            // --- ЛОГІКА РЕЄСТРАЦІЇ СЕРВІС-ВОРКЕРА ---
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            }
        };

        // Запуск програми після повного завантаження сторінки
        window.onload = renderApp;
    </script>
</body>
</html>
